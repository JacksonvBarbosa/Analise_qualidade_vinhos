name: CI
# Eventos que acionam o workflow
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Jobs que serão executados
jobs:
  continous_integration: # Nome do job
    runs-on: ubuntu-latest # Sistema operacional a ser usado
    strategy: # Estratégia de execução
      matrix:
        python-version: [3.11] # Versões do Python a serem testadas
    steps:
      - name: Checkout repo # Checkout do repositório
        uses: actions/checkout@v4 # Action para checkout do repositório

      - name: Setup Python # Configura o ambiente Python
        uses: actions/setup-python@v4 # Action para configurar o ambiente Python
        with:
          python-version: ${{ matrix.python-version }} # Versão do Python a ser usada

      - name: Cache pip # Cache para pip
        uses: actions/cache@v4 # Action para cache
        with:
          path: ~/.cache/pip # Caminho para o cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }} # Chave para o cache
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies # Instala as dependências
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Install package (editable) # Instala o pacote em modo editável
        run: |
          # Ensure build tools available and install package in editable mode
          python -m pip install --upgrade pip setuptools wheel
          pip install poetry-core || true
          pip install -e .

      - name: Add `src` to site-packages via .pth (fallback for imports)
        run: |
          python -c "import sysconfig, pathlib, os; site_packages=pathlib.Path(sysconfig.get_paths()['purelib']); pfile=site_packages / 'analise_qualidade_vinhos_src.pth'; content=str(pathlib.Path.cwd() / 'src') + os.linesep; pfile.write_text(content); print('WROTE', pfile); print('CONTENT:', content)"

      - name: Verify package installation
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          python .github/scripts/verify_import.py

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          echo "PYTHONPATH=$PYTHONPATH"
          python -c "import sys; print('sys.path sample ->', sys.path[:5])"
          pytest -q

      - name: Lint (opcional)
        run: |
          pip install flake8
          flake8 src tests || true