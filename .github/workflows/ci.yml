# name: CI

# on:
#   push:
#     branches: [ main, master ]
#   pull_request:
#     branches: [ main, master ]

# jobs:
#   tests:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       - name: Run tests
#         run: pytest

#   docker-build:
#     runs-on: ubuntu-latest
#     needs: tests
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Build image
#         run: |
#           docker build -t wine-quality .


name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Install package (editable)
        run: |
          # Ensure build tools available and install package in editable mode
          python -m pip install --upgrade pip setuptools wheel
          pip install poetry-core || true
          pip install -e .

      - name: Add `src` to site-packages via .pth (fallback for imports)
        run: |
          python -c "import sysconfig, pathlib, os; site_packages=pathlib.Path(sysconfig.get_paths()['purelib']); pfile=site_packages / 'analise_qualidade_vinhos_src.pth'; content=str(pathlib.Path.cwd() / 'src') + os.linesep; pfile.write_text(content); print('WROTE', pfile); print('CONTENT:', content)"

      - name: Verify package installation
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          python -c "import sys, importlib; print('sys.path[0:3]=', sys.path[0:3]); print('find_spec=', importlib.util.find_spec('analise_qualidade_vinhos'))"
          python -c "import pkgutil; print('modules containing analise_qualidade_vinhos:', [m.name for m in pkgutil.iter_modules(['src']) if 'analise_qualidade_vinhos' in m.name or m.name=='analise_qualidade_vinhos'])"

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          echo "PYTHONPATH=$PYTHONPATH"
          python -c "import sys; print('sys.path sample ->', sys.path[:5])"
          pytest -q

      - name: Lint (opcional)
        run: |
          pip install flake8
          flake8 src tests || true